{% extends 'TriadApp/admin/admin.html' %}

{% block content %}
{% csrf_token %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<div class="p-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">Inventory Management</h1>
        <button onclick="openModal()" 
                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg cursor-pointer">
            Add Item
        </button>
    </div>

    <!-- Items Table -->
    <div class="bg-white shadow-md rounded-lg overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Item ID
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Image</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Size</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Measurement</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Add-ons</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Products</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for item in items %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ item.item_id }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <img src="{{ item.picture.url }}" alt="{{ item.name }}" class="h-12 w-12 object-cover rounded">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">{{ item.name }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">{{ item.category.name }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">{{ item.size|default:"-" }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">{{ item.measurement|default:"-" }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">â‚±{{ item.price }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">{{ item.quantity }}</td>
                    <td class="px-6 py-4">
                        <div class="text-sm">
                            {% for addon in item.itemaddon_set.all %}
                            <div>{{ addon.supply.name }} ({{ addon.quantity_per_item }} {{ addon.supply.unit }})</div>
                            {% empty %}
                            -
                            {% endfor %}
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm">
                            {% for product in item.itemproduct_set.all %}
                            <div>{{ product.supply.name }} ({{ product.quantity_per_item }} {{ product.supply.unit }})</div>
                            {% empty %}
                            -
                            {% endfor %}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if item.is_available %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                            Available
                        </span>
                        {% else %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                            Unavailable
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 text-sm">
                        <button onclick="openEditModal('{{ item.id }}')" 
                                class="text-blue-600 hover:text-blue-700 font-medium mr-3 cursor-pointer">
                            Edit
                        </button>
                        <button onclick="confirmDelete('{{ item.id }}', '{{ item.name|escapejs }}')" 
                                class="text-red-600 hover:text-red-700 font-medium cursor-pointer">
                            Delete
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Item Modal -->
<div id="itemModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-3/4 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4" id="modalTitle">Add Item</h3>
            <form id="itemForm" onsubmit="handleSubmit(event)" enctype="multipart/form-data">
                {% csrf_token %}
                <!-- Basic Information -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Item ID</label>
                        <input type="text" 
                               name="item_id" 
                               id="itemId"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600" 
                               readonly>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Name*</label>
                        <input type="text" 
                               name="name" 
                               id="itemName"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500" 
                               required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Category*</label>
                        <select name="category" 
                                id="itemCategory"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500" 
                                required>
                            <option value="">Select Category</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Price*</label>
                        <input type="number" 
                               name="price" 
                               id="itemPrice"
                               step="0.01"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500" 
                               required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Size</label>
                        <input type="text" 
                               name="size" 
                               id="itemSize"
                               placeholder="e.g., 500ml, Large, 12oz"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Measurement</label>
                        <input type="text" 
                               name="measurement" 
                               id="itemMeasurement"
                               placeholder="e.g., 250g, 1kg"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Quantity*</label>
                        <input type="number" 
                               name="quantity" 
                               id="itemQuantity"
                               min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500" 
                               required>
                    </div>
                </div>

                <!-- Image and Date Section -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Picture*</label>
                        <div id="currentPictureContainer" class="mb-2 hidden">
                            <img id="currentPicture" class="h-32 w-32 object-cover rounded mb-2">
                        </div>
                        <input type="file" 
                               name="picture" 
                               id="itemPicture"
                               accept="image/*"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500" 
                               required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Expiration Date</label>
                        <input type="datetime-local" 
                               name="expiration_date" 
                               id="itemExpirationDate"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
                    </div>
                </div>

                <!-- Products Section -->
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Products*</label>
                    <div id="productContainer" class="space-y-2">
                        <div class="grid grid-cols-6 gap-4 items-center">
                            <select name="products[]" 
                                    class="col-span-4 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"
                                    required>
                                <option value="">Select Product</option>
                                {% for supply in product_supplies %}
                                <option value="{{ supply.id }}">{{ supply.name }} ({{ supply.quantity }} {{ supply.unit }})</option>
                                {% endfor %}
                            </select>
                            <input type="number" 
                                   name="product_quantities[]" 
                                   step="0.01"
                                   placeholder="Quantity"
                                   class="col-span-2 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"
                                   required>
                        </div>
                    </div>
                    <button type="button" 
                            onclick="addSupplyField('productContainer', 'products[]', 'product_quantities[]', true)" 
                            class="mt-2 text-blue-600 hover:text-blue-700 text-sm font-medium">
                        + Add another product
                    </button>
                </div>

                <!-- Add-ons Section -->
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Add-ons</label>
                    <div id="addOnContainer" class="space-y-2">
                        <div class="grid grid-cols-6 gap-4 items-center">
                            <select name="add_ons[]" 
                                    class="col-span-4 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
                                <option value="">Select Add-on</option>
                                {% for supply in add_on_supplies %}
                                <option value="{{ supply.id }}">{{ supply.name }} ({{ supply.quantity }} {{ supply.unit }})</option>
                                {% endfor %}
                            </select>
                            <input type="number" 
                                   name="add_on_quantities[]" 
                                   step="0.01"
                                   min="0"
                                   placeholder="Quantity"
                                   class="col-span-2 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                    </div>
                    <button type="button" 
                            onclick="addSupplyField('addOnContainer', 'add_ons[]', 'add_on_quantities[]', false)" 
                            class="mt-2 text-blue-600 hover:text-blue-700 text-sm font-medium">
                        + Add another add-on
                    </button>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" 
                            onclick="closeModal()" 
                            class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
                        Cancel
                    </button>
                    <button type="submit" 
                            id="submitBtn"
                            class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        Add Item
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Safe JSON parsing function
    function safeJSONParse(str, defaultValue = []) {
        try {
            return JSON.parse(str);
        } catch (e) {
            console.error('JSON Parse Error:', e);
            return defaultValue;
        }
    }

    // Initialize variables first with safe parsing
    let currentItemId = null;
    const productSupplies = safeJSONParse('{{ product_supplies|escapejs|safe }}', []);
    const addOnSupplies = safeJSONParse('{{ add_on_supplies|escapejs|safe }}', []);

    function addSupplyField(containerId, selectName, quantityName, isRequired = false, selectedValue = null, selectedQuantity = null) {
        const container = document.getElementById(containerId);
        const div = document.createElement('div');
        div.className = 'grid grid-cols-6 gap-4 items-center';
        
        const supplies = containerId === 'productContainer' ? productSupplies : addOnSupplies;
        
        div.innerHTML = `
            <select name="${selectName}" 
                    class="col-span-4 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"
                    ${isRequired ? 'required' : ''}>
                <option value="">Select ${containerId === 'productContainer' ? 'Product' : 'Add-on'}</option>
                ${supplies.map(supply => `
                    <option value="${supply.id}" ${selectedValue == supply.id ? 'selected' : ''}>
                        ${supply.name} (${supply.quantity})
                    </option>
                `).join('')}
            </select>
            <input type="number" 
                   name="${quantityName}" 
                   step="0.01"
                   min="0"
                   placeholder="Quantity"
                   value="${selectedQuantity || ''}"
                   class="col-span-2 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"
                   ${isRequired ? 'required' : ''}>
            <button type="button" 
                    onclick="this.parentElement.remove()" 
                    class="text-red-600 hover:text-red-800">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        `;
        
        container.appendChild(div);
    }

    // Modal functions
    function openModal(itemId = null) {
        if (itemId) {
            openEditModal(itemId);
        } else {
            // Reset for new item
            const modal = document.getElementById('itemModal');
            const form = document.getElementById('itemForm');
            const modalTitle = document.getElementById('modalTitle');
            const submitBtn = document.getElementById('submitBtn');

            currentItemId = null;
            form.reset();
            modalTitle.textContent = 'Add Item';
            submitBtn.textContent = 'Add Item';
            document.getElementById('currentPictureContainer').classList.add('hidden');
            document.getElementById('itemPicture').setAttribute('required', '');
            document.getElementById('productContainer').innerHTML = '';
            document.getElementById('addOnContainer').innerHTML = '';
            addSupplyField('productContainer', 'products[]', 'product_quantities[]', true);
            modal.classList.remove('hidden');
        }
    }

    async function openEditModal(itemId) {
        currentItemId = itemId;
        const modal = document.getElementById('itemModal');
        const form = document.getElementById('itemForm');
        const modalTitle = document.getElementById('modalTitle');
        const submitBtn = document.getElementById('submitBtn');

        modalTitle.textContent = 'Edit Item';
        submitBtn.textContent = 'Update Item';

        try {
            const response = await fetch(`/stall-admin/items/${itemId}/edit/`);
            const result = await response.json();

            if (result.status === 'success') {
                const data = result.data;

                // Fill basic fields
                form.querySelector('#itemId').value = data.item_id;
                form.querySelector('#itemName').value = data.name;
                form.querySelector('#itemCategory').value = data.category_id;
                form.querySelector('#itemPrice').value = data.price;
                form.querySelector('#itemQuantity').value = data.quantity;
                form.querySelector('#itemSize').value = data.size || '';
                form.querySelector('#itemMeasurement').value = data.measurement || '';
                if (data.expiration_date) {
                    form.querySelector('#itemExpirationDate').value = data.expiration_date.split('.')[0];
                }

                // Handle picture
                if (data.picture_url) {
                    document.getElementById('currentPicture').src = data.picture_url;
                    document.getElementById('currentPictureContainer').classList.remove('hidden');
                    document.getElementById('itemPicture').removeAttribute('required');
                }

                // Clear and fill products
                const productContainer = document.getElementById('productContainer');
                productContainer.innerHTML = '';
                data.products.forEach(product => {
                    addSupplyField('productContainer', 'products[]', 'product_quantities[]', true, 
                                 product.supply_id, product.quantity);
                });

                // Clear and fill add-ons
                const addOnContainer = document.getElementById('addOnContainer');
                addOnContainer.innerHTML = '';
                data.add_ons.forEach(addon => {
                    addSupplyField('addOnContainer', 'add_ons[]', 'add_on_quantities[]', false, 
                                 addon.supply_id, addon.quantity);
                });

                modal.classList.remove('hidden');
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: error.message || 'Failed to load item data'
            });
        }
    }

    function closeModal() {
        const modal = document.getElementById('itemModal');
        const form = document.getElementById('itemForm');
        const modalTitle = document.getElementById('modalTitle');
        const submitBtn = document.getElementById('submitBtn');

        form.reset();
        modalTitle.textContent = 'Add Item';
        submitBtn.textContent = 'Add Item';
        document.getElementById('currentPictureContainer').classList.add('hidden');
        document.getElementById('itemPicture').setAttribute('required', '');
        document.getElementById('productContainer').innerHTML = '';
        document.getElementById('addOnContainer').innerHTML = '';
        addSupplyField('productContainer', 'products[]', 'product_quantities[]', true);
        currentItemId = null;
        modal.classList.add('hidden');
    }

    async function handleSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const url = currentItemId ? `/stall-admin/items/${currentItemId}/edit/` : '/stall-admin/items/add/';

        try {
            const response = await fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });

            const result = await response.json();

            if (result.status === 'success') {
                Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: result.message,
                    timer: 1500,
                    showConfirmButton: false
                }).then(() => {
                    window.location.reload();
                });
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: error.message || 'An error occurred while saving'
            });
        }
    }

    function confirmDelete(itemId, itemName) {
        Swal.fire({
            title: 'Are you sure?',
            text: `Do you want to delete "${itemName}"?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                deleteItem(itemId);
            }
        });
    }

    function deleteItem(itemId) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        fetch(`/stall-admin/items/delete/${itemId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                Swal.fire({
                    icon: 'success',
                    title: 'Deleted!',
                    text: result.message,
                    timer: 1500
                }).then(() => {
                    window.location.reload();
                });
            } else {
                throw new Error(result.message);
            }
        })
        .catch(error => {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: error.message || 'Failed to delete item'
            });
        });
    }

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // DOM Ready handler
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize first product field
        addSupplyField('productContainer', 'products[]', 'product_quantities[]', true);

        // Close modal when clicking outside
        document.getElementById('itemModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Function to generate item ID
        function generateItemId() {
            const stallPrefix = "{{ stall.name|slice:':3'|upper }}";
            const timestamp = new Date().toISOString()
                .slice(2,16)
                .replace(/[-T:]/g, '');
            const randomSuffix = Math.floor(Math.random() * 10000)
                .toString()
                .padStart(4, '0');
            return `${stallPrefix}-${timestamp}-${randomSuffix}`;
        }

        // Set initial item ID when form is shown
        const addItemModal = document.getElementById('addItemModal');
        if (addItemModal) {
            addItemModal.addEventListener('show.bs.modal', function() {
                document.getElementById('item_id').value = generateItemId();
            });
        }

        // Update item ID when form is reset
        const addItemForm = document.getElementById('addItemForm');
        if (addItemForm) {
            addItemForm.addEventListener('reset', function() {
                document.getElementById('item_id').value = generateItemId();
            });
        }
    });

    // Update your existing addItem function
    function addItem(event) {
        event.preventDefault();
        
        const itemId = document.getElementById('item_id').value;
        
        // Validate item ID format
        if (!/^[A-Za-z0-9-]+$/.test(itemId)) {
            Swal.fire({
                icon: 'error',
                title: 'Invalid Item ID',
                text: 'Item ID can only contain letters, numbers, and hyphens'
            });
            return;
        }
        
        const formData = new FormData(event.target);
        
        fetch('/stall-admin/inventory/add/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: result.message,
                    timer: 1500
                }).then(() => {
                    window.location.reload();
                });
            } else {
                throw new Error(result.message);
            }
        })
        .catch(error => {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: error.message || 'Failed to add item'
            });
        });
    }

 
</script>
{% endblock %}
